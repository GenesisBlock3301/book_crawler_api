import aiohttp
import pytest
from starlette import status
from app.db import books_collection
from app.utils import settings

test_books = [
    {
        "_id": "68ef592950ca2000ff19b018",
        "name": "Chase Me (Paris Nights #2)",
        "availability": "In stock (19 available)",
        "category": "Unknown",
        "crawl_timestamp": "2025-10-15T14:34:23.289311",
        "description": "A Michelin two-star chef at twenty-eight, Violette Lenoir could handle anything, including a cocky burglar who broke into her restaurant in the middle of the night.Or so she thought.Elite counterterrorist operative Chase “Smith” had been through things that made Hell Week look easy. But nothing had prepared him for a leather-clad blonde who held him at bay at knifepoint an A Michelin two-star chef at twenty-eight, Violette Lenoir could handle anything, including a cocky burglar who broke into her restaurant in the middle of the night.Or so she thought.Elite counterterrorist operative Chase “Smith” had been through things that made Hell Week look easy. But nothing had prepared him for a leather-clad blonde who held him at bay at knifepoint and dared him to take her on.Now if only saving the world didn’t require he ruin her life.Two people who thought they could handle anything now have to take on each other. It's a battle neither one expected. But with their futures on the line, they have nothing to lose...but their hearts.Warning: This book contains one arrogant Navy SEAL, nights of Paris passion, and a woman who wants to have it all. ...more",
        "image_url": "https://books.toscrape.com/media/cache/6c/84/6c84fcf7a53b02b6e763de7272934842.jpg",
        "num_reviews": 0,
        "price_excl_tax": 25.27,
        "price_incl_tax": 25.27,
        "rating": "Five",
        "row_html": "\n\n<!DOCTYPE html>\n<!--[if lt IE 7]>      <html lang=\"en-us\" class=\"no-js lt-ie9 lt-ie8 lt-ie7\"> <![endif]-->\n<!--[if IE 7]>         <html lang=\"en-us\" class=\"no-js lt-ie9 lt-ie8\"> <![endif]-->\n<!--[if IE 8]>         <html lang=\"en-us\" class=\"no-js lt-ie9\"> <![endif]-->\n<!--[if gt IE 8]><!--> <html lang=\"en-us\" class=\"no-js\"> <!--<![endif]-->\n    <head>\n        <title>\n    Chase Me (Paris Nights #2) | Books to Scrape - Sandbox\n</title>\n\n        <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\" />\n        <meta name=\"created\" content=\"24th Jun 2016 09:29\" />\n        <meta name=\"description\" content=\"\n    A Michelin two-star chef at twenty-eight, Violette Lenoir could handle anything, including a cocky burglar who broke into her restaurant in the middle of the night.Or so she thought.Elite counterterrorist operative Chase “Smith” had been through things that made Hell Week look easy. But nothing had prepared him for a leather-clad blonde who held him at bay at knifepoint an A Michelin two-star chef at twenty-eight, Violette Lenoir could handle anything, including a cocky burglar who broke into her restaurant in the middle of the night.Or so she thought.Elite counterterrorist operative Chase “Smith” had been through things that made Hell Week look easy. But nothing had prepared him for a leather-clad blonde who held him at bay at knifepoint and dared him to take her on.Now if only saving the world didn’t require he ruin her life.Two people who thought they could handle anything now have to take on each other. It&#39;s a battle neither one expected. But with their futures on the line, they have nothing to lose...but their hearts.Warning: This book contains one arrogant Navy SEAL, nights of Paris passion, and a woman who wants to have it all. ...more\n\" />\n        <meta name=\"viewport\" content=\"width=device-width\" />\n        <meta name=\"robots\" content=\"NOARCHIVE,NOCACHE\" />\n\n        <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->\n        <!--[if lt IE 9]>\n        <script src=\"//html5shim.googlecode.com/svn/trunk/html5.js\"></script>\n        <![endif]-->\n\n        \n            <link rel=\"shortcut icon\" href=\"../../static/oscar/favicon.ico\" />\n        \n\n        \n        \n    \n    \n        <link rel=\"stylesheet\" type=\"text/css\" href=\"../../static/oscar/css/styles.css\" />\n    \n    <link rel=\"stylesheet\" href=\"../../static/oscar/js/bootstrap-datetimepicker/bootstrap-datetimepicker.css\" />\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../../static/oscar/css/datetimepicker.css\" />\n\n\n        \n        \n\n        \n\n        \n            \n            \n\n        \n    </head>\n\n    <body id=\"default\" class=\"default\">\n        \n        \n    \n    \n    <header class=\"header container-fluid\">\n        <div class=\"page_inner\">\n            <div class=\"row\">\n                <div class=\"col-sm-8 h1\"><a href=\"../../index.html\">Books to Scrape</a><small> We love being scraped!</small>\n</div>\n\n                \n            </div>\n        </div>\n    </header>\n\n    \n    \n        <div class=\"container-fluid page\">\n            <div class=\"page_inner\">\n                \n<ul class=\"breadcrumb\">\n    <li>\n        <a href=\"../../index.html\">Home</a>\n    </li>\n    \n        \n        <li>\n            <a href=\"../category/books_1/index.html\">Books</a>\n        </li>\n        \n        <li>\n            <a href=\"../category/books/romance_8/index.html\">Romance</a>\n        </li>\n        \n        <li class=\"active\">Chase Me (Paris Nights #2)</li>\n\n        \n        \n    \n</ul>\n\n                \n\n                \n\n\n\n<div id=\"messages\">\n\n</div>\n\n                \n                <div class=\"content\">\n                    \n\n                    \n                    <div id=\"promotions\">\n                        \n                    </div>\n\n                    \n                    <div id=\"content_inner\">\n\n<article class=\"product_page\"><!-- Start of product page -->\n\n    <div class=\"row\">\n\n        \n        <div class=\"col-sm-6\">\n            \n\n\n\n\n    \n\n    \n\n        \n        <div id=\"product_gallery\" class=\"carousel\">\n            <div class=\"thumbnail\">\n                <div class=\"carousel-inner\">\n                    <div class=\"item active\">\n                    \n                        \n                            <img src=\"../../media/cache/6c/84/6c84fcf7a53b02b6e763de7272934842.jpg\" alt=\"Chase Me (Paris Nights #2)\" />\n                        \n                    \n                    </div>\n                </div>\n            </div>\n        </div>\n\n    \n\n\n        </div>\n        \n\n        \n        <div class=\"col-sm-6 product_main\">\n            \n            \n            <h1>Chase Me (Paris Nights #2)</h1>\n\n            \n                \n\n\n\n\n\n\n    \n        <p class=\"price_color\">£25.27</p>\n    \n\n<p class=\"instock availability\">\n    <i class=\"icon-ok\"></i>\n    \n        In stock (19 available)\n    \n</p>\n\n            \n\n            \n                \n\n\n\n    <p class=\"star-rating Five\">\n        <i class=\"icon-star\"></i>\n        <i class=\"icon-star\"></i>\n        <i class=\"icon-star\"></i>\n        <i class=\"icon-star\"></i>\n        <i class=\"icon-star\"></i>\n\n        <!-- <small><a href=\"/catalogue/chase-me-paris-nights-2_977/reviews/\">\n        \n                \n                    0 customer reviews\n                \n        </a></small>\n         -->&nbsp;\n\n\n<!-- \n    <a id=\"write_review\" href=\"/catalogue/chase-me-paris-nights-2_977/reviews/add/#addreview\" class=\"btn btn-success btn-sm\">\n        Write a review\n    </a>\n\n --></p>\n\n            \n\n            <hr/>\n\n            <div class=\"alert alert-warning\" role=\"alert\"><strong>Warning!</strong> This is a demo website for web scraping purposes. Prices and ratings here were randomly assigned and have no real meaning.</div>\n\n\n            \n                \n\n\n\n\n\n\n            \n        </div><!-- /col-sm-6 -->\n        \n\n    </div><!-- /row -->\n\n    \n        \n        <div id=\"product_description\" class=\"sub-header\">\n            <h2>Product Description</h2>\n        </div>\n        <p>A Michelin two-star chef at twenty-eight, Violette Lenoir could handle anything, including a cocky burglar who broke into her restaurant in the middle of the night.Or so she thought.Elite counterterrorist operative Chase “Smith” had been through things that made Hell Week look easy. But nothing had prepared him for a leather-clad blonde who held him at bay at knifepoint an A Michelin two-star chef at twenty-eight, Violette Lenoir could handle anything, including a cocky burglar who broke into her restaurant in the middle of the night.Or so she thought.Elite counterterrorist operative Chase “Smith” had been through things that made Hell Week look easy. But nothing had prepared him for a leather-clad blonde who held him at bay at knifepoint and dared him to take her on.Now if only saving the world didn’t require he ruin her life.Two people who thought they could handle anything now have to take on each other. It's a battle neither one expected. But with their futures on the line, they have nothing to lose...but their hearts.Warning: This book contains one arrogant Navy SEAL, nights of Paris passion, and a woman who wants to have it all. ...more</p>\n        \n    \n\n    \n    <div class=\"sub-header\">\n        <h2>Product Information</h2>\n    </div>\n    <table class=\"table table-striped\">\n        \n        <tr>\n            <th>UPC</th><td>c2e46a2ee3b4a322</td>\n        </tr>\n        \n        <tr>\n            <th>Product Type</th><td>Books</td>\n        </tr>\n\n        \n        \n            <tr>\n                <th>Price (excl. tax)</th><td>£25.27</td>\n            </tr>\n            \n                <tr>\n                    <th>Price (incl. tax)</th><td>£25.27</td>\n                </tr>\n                <tr>\n                    <th>Tax</th><td>£0.00</td>\n                </tr>\n            \n            <tr>\n                <th>Availability</th>\n                <td>In stock (19 available)</td>\n            </tr>\n        \n        \n        \n            <tr>\n                <th>Number of reviews</th>\n                <td>0</td>\n            </tr>\n        \n    </table>\n    \n\n    \n        \n        <section>\n            <div id=\"reviews\" class=\"sub-header\">\n            </div>\n        </section>\n        \n    \n\n    \n        \n    \n\n    \n\n\n\n    \n        <div class=\"sub-header\">\n            <h2>Products you recently viewed</h2>\n        </div>\n\n        <ul class=\"row\">\n            \n                <li class=\"col-xs-6 col-sm-4 col-md-3 col-lg-3\">\n\n\n\n\n\n\n    <article class=\"product_pod\">\n        \n            <div class=\"image_container\">\n                \n                    \n                    <a href=\"../beyond-good-and-evil_6/index.html\"><img src=\"../../media/cache/ab/45/ab45f300aa15066ad1260d6f1398d03e.jpg\" alt=\"Beyond Good and Evil\" class=\"thumbnail\"></a>\n                    \n                \n            </div>\n        \n\n        \n            \n                <p class=\"star-rating One\">\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                </p>\n            \n        \n\n        \n            <h3><a href=\"../beyond-good-and-evil_6/index.html\" title=\"Beyond Good and Evil\">Beyond Good and Evil</a></h3>\n        \n\n        \n            <div class=\"product_price\">\n                \n\n\n\n\n\n\n    \n        <p class=\"price_color\">£43.38</p>\n    \n\n<p class=\"instock availability\">\n    <i class=\"icon-ok\"></i>\n    \n        In stock\n    \n</p>\n\n                \n                    \n\n\n\n\n\n\n    \n    <form>\n        <button type=\"submit\" class=\"btn btn-primary btn-block\" data-loading-text=\"Adding...\">Add to basket</button>\n    </form>\n\n\n                \n            </div>\n        \n    </article>\n\n</li>\n            \n                <li class=\"col-xs-6 col-sm-4 col-md-3 col-lg-3\">\n\n\n\n\n\n\n    <article class=\"product_pod\">\n        \n            <div class=\"image_container\">\n                \n                    \n                    <a href=\"../meditations_33/index.html\"><img src=\"../../media/cache/df/c9/dfc9ed72e963572d23233b3a8cb01676.jpg\" alt=\"Meditations\" class=\"thumbnail\"></a>\n                    \n                \n            </div>\n        \n\n        \n            \n                <p class=\"star-rating Two\">\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                </p>\n            \n        \n\n        \n            <h3><a href=\"../meditations_33/index.html\" title=\"Meditations\">Meditations</a></h3>\n        \n\n        \n            <div class=\"product_price\">\n                \n\n\n\n\n\n\n    \n        <p class=\"price_color\">£25.89</p>\n    \n\n<p class=\"instock availability\">\n    <i class=\"icon-ok\"></i>\n    \n        In stock\n    \n</p>\n\n                \n                    \n\n\n\n\n\n\n    \n    <form>\n        <button type=\"submit\" class=\"btn btn-primary btn-block\" data-loading-text=\"Adding...\">Add to basket</button>\n    </form>\n\n\n                \n            </div>\n        \n    </article>\n\n</li>\n            \n                <li class=\"col-xs-6 col-sm-4 col-md-3 col-lg-3\">\n\n\n\n\n\n\n    <article class=\"product_pod\">\n        \n            <div class=\"image_container\">\n                \n                    \n                    <a href=\"../the-nicomachean-ethics_75/index.html\"><img src=\"../../media/cache/f0/aa/f0aa9ae0319b1d6e0706e6053020e696.jpg\" alt=\"The Nicomachean Ethics\" class=\"thumbnail\"></a>\n                    \n                \n            </div>\n        \n\n        \n            \n                <p class=\"star-rating One\">\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                </p>\n            \n        \n\n        \n            <h3><a href=\"../the-nicomachean-ethics_75/index.html\" title=\"The Nicomachean Ethics\">The Nicomachean Ethics</a></h3>\n        \n\n        \n            <div class=\"product_price\">\n                \n\n\n\n\n\n\n    \n        <p class=\"price_color\">£36.34</p>\n    \n\n<p class=\"instock availability\">\n    <i class=\"icon-ok\"></i>\n    \n        In stock\n    \n</p>\n\n                \n                    \n\n\n\n\n\n\n    \n    <form>\n        <button type=\"submit\" class=\"btn btn-primary btn-block\" data-loading-text=\"Adding...\">Add to basket</button>\n    </form>\n\n\n                \n            </div>\n        \n    </article>\n\n</li>\n            \n                <li class=\"col-xs-6 col-sm-4 col-md-3 col-lg-3\">\n\n\n\n\n\n\n    <article class=\"product_pod\">\n        \n            <div class=\"image_container\">\n                \n                    \n                    <a href=\"../run-spot-run-the-ethics-of-keeping-pets_106/index.html\"><img src=\"../../media/cache/91/e6/91e6190dcdd7d6cdeb94a82b60917ec4.jpg\" alt=\"Run, Spot, Run: The Ethics of Keeping Pets\" class=\"thumbnail\"></a>\n                    \n                \n            </div>\n        \n\n        \n            \n                <p class=\"star-rating One\">\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                </p>\n            \n        \n\n        \n            <h3><a href=\"../run-spot-run-the-ethics-of-keeping-pets_106/index.html\" title=\"Run, Spot, Run: The Ethics of Keeping Pets\">Run, Spot, Run: The ...</a></h3>\n        \n\n        \n            <div class=\"product_price\">\n                \n\n\n\n\n\n\n    \n        <p class=\"price_color\">£20.02</p>\n    \n\n<p class=\"instock availability\">\n    <i class=\"icon-ok\"></i>\n    \n        In stock\n    \n</p>\n\n                \n                    \n\n\n\n\n\n\n    \n    <form>\n        <button type=\"submit\" class=\"btn btn-primary btn-block\" data-loading-text=\"Adding...\">Add to basket</button>\n    </form>\n\n\n                \n            </div>\n        \n    </article>\n\n</li>\n            \n                <li class=\"col-xs-6 col-sm-4 col-md-3 col-lg-3\">\n\n\n\n\n\n\n    <article class=\"product_pod\">\n        \n            <div class=\"image_container\">\n                \n                    \n                    <a href=\"../critique-of-pure-reason_366/index.html\"><img src=\"../../media/cache/12/6e/126ef8f6473b81808ebbb9cff155e883.jpg\" alt=\"Critique of Pure Reason\" class=\"thumbnail\"></a>\n                    \n                \n            </div>\n        \n\n        \n            \n                <p class=\"star-rating One\">\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                </p>\n            \n        \n\n        \n            <h3><a href=\"../critique-of-pure-reason_366/index.html\" title=\"Critique of Pure Reason\">Critique of Pure Reason</a></h3>\n        \n\n        \n            <div class=\"product_price\">\n                \n\n\n\n\n\n\n    \n        <p class=\"price_color\">£20.75</p>\n    \n\n<p class=\"instock availability\">\n    <i class=\"icon-ok\"></i>\n    \n        In stock\n    \n</p>\n\n                \n                    \n\n\n\n\n\n\n    \n    <form>\n        <button type=\"submit\" class=\"btn btn-primary btn-block\" data-loading-text=\"Adding...\">Add to basket</button>\n    </form>\n\n\n                \n            </div>\n        \n    </article>\n\n</li>\n            \n                <li class=\"col-xs-6 col-sm-4 col-md-3 col-lg-3\">\n\n\n\n\n\n\n    <article class=\"product_pod\">\n        \n            <div class=\"image_container\">\n                \n                    \n                    <a href=\"../at-the-existentialist-cafe-freedom-being-and-apricot-cocktails-with-jean-paul-sartre-simone-de-beauvoir-albert-camus-martin-heidegger-edmund-husserl-karl-jaspers-maurice-merleau-ponty-and-others_459/index.html\"><img src=\"../../media/cache/de/76/de76d5c473c358bd41c03cf710692bfb.jpg\" alt=\"At The Existentialist Café: Freedom, Being, and apricot cocktails with: Jean-Paul Sartre, Simone de Beauvoir, Albert Camus, Martin Heidegger, Edmund Husserl, Karl Jaspers, Maurice Merleau-Ponty and others\" class=\"thumbnail\"></a>\n                    \n                \n            </div>\n        \n\n        \n            \n                <p class=\"star-rating Five\">\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                    <i class=\"icon-star\"></i>\n                </p>\n            \n        \n\n        \n            <h3><a href=\"../at-the-existentialist-cafe-freedom-being-and-apricot-cocktails-with-jean-paul-sartre-simone-de-beauvoir-albert-camus-martin-heidegger-edmund-husserl-karl-jaspers-maurice-merleau-ponty-and-others_459/index.html\" title=\"At The Existentialist Café: Freedom, Being, and apricot cocktails with: Jean-Paul Sartre, Simone de Beauvoir, Albert Camus, Martin Heidegger, Edmund Husserl, Karl Jaspers, Maurice Merleau-Ponty and others\">At The Existentialist Café: ...</a></h3>\n        \n\n        \n            <div class=\"product_price\">\n                \n\n\n\n\n\n\n    \n        <p class=\"price_color\">£29.93</p>\n    \n\n<p class=\"instock availability\">\n    <i class=\"icon-ok\"></i>\n    \n        In stock\n    \n</p>\n\n                \n                    \n\n\n\n\n\n\n    \n    <form>\n        <button type=\"submit\" class=\"btn btn-primary btn-block\" data-loading-text=\"Adding...\">Add to basket</button>\n    </form>\n\n\n                \n            </div>\n        \n    </article>\n\n</li>\n            \n        </ul>\n    \n\n\n\n</article><!-- End of product page -->\n</div>\n                </div>\n            </div>\n        </div>\n    \n\n    \n<footer class=\"footer container-fluid\">\n    \n        \n    \n</footer>\n\n\n        \n        \n  \n            <!-- jQuery -->\n            <script src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js\"></script>\n            <script>window.jQuery || document.write('<script src=\"../../static/oscar/js/jquery/jquery-1.9.1.min.js\"><\\/script>')</script>\n        \n  \n\n\n        \n        \n    \n        \n    <!-- Twitter Bootstrap -->\n    <script type=\"text/javascript\" src=\"../../static/oscar/js/bootstrap3/bootstrap.min.js\"></script>\n    <!-- Oscar -->\n    <script src=\"../../static/oscar/js/oscar/ui.js\" type=\"text/javascript\" charset=\"utf-8\"></script>\n\n    <script src=\"../../static/oscar/js/bootstrap-datetimepicker/bootstrap-datetimepicker.js\" type=\"text/javascript\" charset=\"utf-8\"></script>\n    <script src=\"../../static/oscar/js/bootstrap-datetimepicker/locales/bootstrap-datetimepicker.all.js\" type=\"text/javascript\" charset=\"utf-8\"></script>\n\n\n        \n        \n    \n    \n\n    \n\n\n\n        \n        <script type=\"text/javascript\">\n            $(function() {\n                \n    \n    oscar.init();\n\n            });\n        </script>\n\n        \n        <!-- Version: N/A -->\n        \n    </body>\n</html>\n",
        "source_url": "https://books.toscrape.com/catalogue/chase-me-paris-nights-2_977/index.html"
    },
    {
        "_id": "68ef592250ca2000ff19b001",
        "name": "A Light in the Attic",
        "availability": "In stock (22 available)",
        "category": "Unknown",
        "crawl_timestamp": "2025-10-15T14:34:15.996968",
        "description": "It's hard to imagine a world without A Light in the Attic. This now-classic collection of poetry and drawings from Shel Silverstein celebrates its 20th anniversary with this special edition. Silverstein's humorous and creative verse can amuse the dowdiest of readers. Lemon-faced adults and fidgety kids sit still and read these rhythmic words and laugh and smile and love th It's hard to imagine a world without A Light in the Attic. This now-classic collection of poetry and drawings from Shel Silverstein celebrates its 20th anniversary with this special edition. Silverstein's humorous and creative verse can amuse the dowdiest of readers. Lemon-faced adults and fidgety kids sit still and read these rhythmic words and laugh and smile and love that Silverstein. Need proof of his genius? RockabyeRockabye baby, in the treetopDon't you know a treetopIs no safe place to rock?And who put you up there,And your cradle, too?Baby, I think someone down here'sGot it in for you. Shel, you never sounded so good. ...more",
        "image_url": "https://books.toscrape.com/media/cache/fe/72/fe72f0532301ec28892ae79a629a293c.jpg",
        "num_reviews": 0,
        "price_excl_tax": 51.77,
        "price_incl_tax": 51.77,
        "rating": "Three",
        "row_html": "\n\n<!DOCTYPE html>\n<!--[if lt IE 7]>      <html lang=\"en-us\" class=\"no-js lt-ie9 lt-ie8 lt-ie7\"> <![endif]-->\n<!--[if IE 7]>         <html lang=\"en-us\" class=\"no-js lt-ie9 lt-ie8\"> <![endif]-->\n<!--[if IE 8]>         <html lang=\"en-us\" class=\"no-js lt-ie9\"> <![endif]-->\n<!--[if gt IE 8]><!--> <html lang=\"en-us\" class=\"no-js\"> <!--<![endif]-->\n    <head>\n        <title>\n    A Light in the Attic | Books to Scrape - Sandbox\n</title>\n\n        <meta http-equiv=\"content-type\" content=\"text/html; charset=UTF-8\" />\n        <meta name=\"created\" content=\"24th Jun 2016 09:29\" />\n        <meta name=\"description\" content=\"\n    It&#39;s hard to imagine a world without A Light in the Attic. This now-classic collection of poetry and drawings from Shel Silverstein celebrates its 20th anniversary with this special edition. Silverstein&#39;s humorous and creative verse can amuse the dowdiest of readers. Lemon-faced adults and fidgety kids sit still and read these rhythmic words and laugh and smile and love th It&#39;s hard to imagine a world without A Light in the Attic. This now-classic collection of poetry and drawings from Shel Silverstein celebrates its 20th anniversary with this special edition. Silverstein&#39;s humorous and creative verse can amuse the dowdiest of readers. Lemon-faced adults and fidgety kids sit still and read these rhythmic words and laugh and smile and love that Silverstein. Need proof of his genius? RockabyeRockabye baby, in the treetopDon&#39;t you know a treetopIs no safe place to rock?And who put you up there,And your cradle, too?Baby, I think someone down here&#39;sGot it in for you. Shel, you never sounded so good. ...more\n\" />\n        <meta name=\"viewport\" content=\"width=device-width\" />\n        <meta name=\"robots\" content=\"NOARCHIVE,NOCACHE\" />\n\n        <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->\n        <!--[if lt IE 9]>\n        <script src=\"//html5shim.googlecode.com/svn/trunk/html5.js\"></script>\n        <![endif]-->\n\n        \n            <link rel=\"shortcut icon\" href=\"../../static/oscar/favicon.ico\" />\n        \n\n        \n        \n    \n    \n        <link rel=\"stylesheet\" type=\"text/css\" href=\"../../static/oscar/css/styles.css\" />\n    \n    <link rel=\"stylesheet\" href=\"../../static/oscar/js/bootstrap-datetimepicker/bootstrap-datetimepicker.css\" />\n    <link rel=\"stylesheet\" type=\"text/css\" href=\"../../static/oscar/css/datetimepicker.css\" />\n\n\n        \n        \n\n        \n\n        \n            \n            \n\n        \n    </head>\n\n    <body id=\"default\" class=\"default\">\n        \n        \n    \n    \n    <header class=\"header container-fluid\">\n        <div class=\"page_inner\">\n            <div class=\"row\">\n                <div class=\"col-sm-8 h1\"><a href=\"../../index.html\">Books to Scrape</a><small> We love being scraped!</small>\n</div>\n\n                \n            </div>\n        </div>\n    </header>\n\n    \n    \n        <div class=\"container-fluid page\">\n            <div class=\"page_inner\">\n                \n<ul class=\"breadcrumb\">\n    <li>\n        <a href=\"../../index.html\">Home</a>\n    </li>\n    \n        \n        <li>\n            <a href=\"../category/books_1/index.html\">Books</a>\n        </li>\n        \n        <li>\n            <a href=\"../category/books/poetry_23/index.html\">Poetry</a>\n        </li>\n        \n        <li class=\"active\">A Light in the Attic</li>\n\n        \n        \n    \n</ul>\n\n                \n\n                \n\n\n\n<div id=\"messages\">\n\n</div>\n\n                \n                <div class=\"content\">\n                    \n\n                    \n                    <div id=\"promotions\">\n                        \n                    </div>\n\n                    \n                    <div id=\"content_inner\">\n\n<article class=\"product_page\"><!-- Start of product page -->\n\n    <div class=\"row\">\n\n        \n        <div class=\"col-sm-6\">\n            \n\n\n\n\n    \n\n    \n\n        \n        <div id=\"product_gallery\" class=\"carousel\">\n            <div class=\"thumbnail\">\n                <div class=\"carousel-inner\">\n                    <div class=\"item active\">\n                    \n                        \n                            <img src=\"../../media/cache/fe/72/fe72f0532301ec28892ae79a629a293c.jpg\" alt=\"A Light in the Attic\" />\n                        \n                    \n                    </div>\n                </div>\n            </div>\n        </div>\n\n    \n\n\n        </div>\n        \n\n        \n        <div class=\"col-sm-6 product_main\">\n            \n            \n            <h1>A Light in the Attic</h1>\n\n            \n                \n\n\n\n\n\n\n    \n        <p class=\"price_color\">£51.77</p>\n    \n\n<p class=\"instock availability\">\n    <i class=\"icon-ok\"></i>\n    \n        In stock (22 available)\n    \n</p>\n\n            \n\n            \n                \n\n\n\n    <p class=\"star-rating Three\">\n        <i class=\"icon-star\"></i>\n        <i class=\"icon-star\"></i>\n        <i class=\"icon-star\"></i>\n        <i class=\"icon-star\"></i>\n        <i class=\"icon-star\"></i>\n\n        <!-- <small><a href=\"/catalogue/a-light-in-the-attic_1000/reviews/\">\n        \n                \n                    0 customer reviews\n                \n        </a></small>\n         -->&nbsp;\n\n\n<!-- \n    <a id=\"write_review\" href=\"/catalogue/a-light-in-the-attic_1000/reviews/add/#addreview\" class=\"btn btn-success btn-sm\">\n        Write a review\n    </a>\n\n --></p>\n\n            \n\n            <hr/>\n\n            <div class=\"alert alert-warning\" role=\"alert\"><strong>Warning!</strong> This is a demo website for web scraping purposes. Prices and ratings here were randomly assigned and have no real meaning.</div>\n\n\n            \n                \n\n\n\n\n\n\n            \n        </div><!-- /col-sm-6 -->\n        \n\n    </div><!-- /row -->\n\n    \n        \n        <div id=\"product_description\" class=\"sub-header\">\n            <h2>Product Description</h2>\n        </div>\n        <p>It's hard to imagine a world without A Light in the Attic. This now-classic collection of poetry and drawings from Shel Silverstein celebrates its 20th anniversary with this special edition. Silverstein's humorous and creative verse can amuse the dowdiest of readers. Lemon-faced adults and fidgety kids sit still and read these rhythmic words and laugh and smile and love th It's hard to imagine a world without A Light in the Attic. This now-classic collection of poetry and drawings from Shel Silverstein celebrates its 20th anniversary with this special edition. Silverstein's humorous and creative verse can amuse the dowdiest of readers. Lemon-faced adults and fidgety kids sit still and read these rhythmic words and laugh and smile and love that Silverstein. Need proof of his genius? RockabyeRockabye baby, in the treetopDon't you know a treetopIs no safe place to rock?And who put you up there,And your cradle, too?Baby, I think someone down here'sGot it in for you. Shel, you never sounded so good. ...more</p>\n        \n    \n\n    \n    <div class=\"sub-header\">\n        <h2>Product Information</h2>\n    </div>\n    <table class=\"table table-striped\">\n        \n        <tr>\n            <th>UPC</th><td>a897fe39b1053632</td>\n        </tr>\n        \n        <tr>\n            <th>Product Type</th><td>Books</td>\n        </tr>\n\n        \n        \n            <tr>\n                <th>Price (excl. tax)</th><td>£51.77</td>\n            </tr>\n            \n                <tr>\n                    <th>Price (incl. tax)</th><td>£51.77</td>\n                </tr>\n                <tr>\n                    <th>Tax</th><td>£0.00</td>\n                </tr>\n            \n            <tr>\n                <th>Availability</th>\n                <td>In stock (22 available)</td>\n            </tr>\n        \n        \n        \n            <tr>\n                <th>Number of reviews</th>\n                <td>0</td>\n            </tr>\n        \n    </table>\n    \n\n    \n        \n        <section>\n            <div id=\"reviews\" class=\"sub-header\">\n            </div>\n        </section>\n        \n    \n\n    \n        \n    \n\n    \n\n\n\n    \n\n\n\n</article><!-- End of product page -->\n</div>\n                </div>\n            </div>\n        </div>\n    \n\n    \n<footer class=\"footer container-fluid\">\n    \n        \n    \n</footer>\n\n\n        \n        \n  \n            <!-- jQuery -->\n            <script src=\"http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js\"></script>\n            <script>window.jQuery || document.write('<script src=\"../../static/oscar/js/jquery/jquery-1.9.1.min.js\"><\\/script>')</script>\n        \n  \n\n\n        \n        \n    \n        \n    <!-- Twitter Bootstrap -->\n    <script type=\"text/javascript\" src=\"../../static/oscar/js/bootstrap3/bootstrap.min.js\"></script>\n    <!-- Oscar -->\n    <script src=\"../../static/oscar/js/oscar/ui.js\" type=\"text/javascript\" charset=\"utf-8\"></script>\n\n    <script src=\"../../static/oscar/js/bootstrap-datetimepicker/bootstrap-datetimepicker.js\" type=\"text/javascript\" charset=\"utf-8\"></script>\n    <script src=\"../../static/oscar/js/bootstrap-datetimepicker/locales/bootstrap-datetimepicker.all.js\" type=\"text/javascript\" charset=\"utf-8\"></script>\n\n\n        \n        \n    \n    \n\n    \n\n\n\n        \n        <script type=\"text/javascript\">\n            $(function() {\n                \n    \n    oscar.init();\n\n            });\n        </script>\n\n        \n        <!-- Version: N/A -->\n        \n    </body>\n</html>\n",
        "source_url": "https://books.toscrape.com/catalogue/a-light-in-the-attic_1000/index.html"
    }
]

TEST_BASE_URL = "http://localhost:8000"
TEST_API_KEY = "supersecretkey123"
EXPECTED_SUCCESS_STATUS = status.HTTP_200_OK
FICTION_CATEGORY = "A Light in the Attic"



@pytest.fixture(autouse=True)
async def setup_db():
    await books_collection.insert_many(test_books)
    yield
    await books_collection.delete_many({})


@pytest.mark.asyncio
async def test_get_books_no_filter():
    headers = {"x-api-key": TEST_API_KEY}
    endpoint = "api/books"

    async with aiohttp.ClientSession() as session:
        async with session.get(f"{settings.HOST}/{endpoint}", headers=headers) as response:
            assert response.status == status.HTTP_200_OK
            data = await response.json()
    assert any(book["name"] == "A Light in the Attic" for book in data['results'])


@pytest.mark.asyncio
async def test_get_book_by_id_found():
    test_book = test_books[1]
    book_id = test_book["_id"]
    headers = {"x-api-key": TEST_API_KEY}
    endpoint = f"api/books/{book_id}"

    async with aiohttp.ClientSession() as session:
        async with session.get(f"{settings.HOST}/{endpoint}", headers=headers) as response:
            assert response.status == status.HTTP_200_OK
            data = await response.json()

    assert data['name'] == test_book['name']
    assert data['price_incl_tax'] == test_book['price_incl_tax']
    assert data['num_reviews'] == test_book['num_reviews']
    assert data['rating'] == test_book['rating']
    assert data['image_url'] == test_book['image_url']
    assert data['source_url'] == test_book['source_url']
    assert data['row_html'] == test_book['row_html']


@pytest.mark.asyncio
async def test_get_book_by_id_not_found():
    non_existent_id = "68ef592950ca2000ff19b118"
    headers = {"x-api-key": TEST_API_KEY}
    endpoint = f"api/books/{non_existent_id}"

    async with aiohttp.ClientSession() as session:
        async with session.get(f"{settings.HOST}/{endpoint}", headers=headers) as response:
            assert response.status == status.HTTP_404_NOT_FOUND
            data = await response.json()

    assert data["detail"] == "Book not found"


@pytest.mark.asyncio
async def test_internal_server_error_to_get_book_by_id():
    headers = {"x-api-key": TEST_API_KEY}
    non_existent_id = "nonexistentid1234567890"
    endpoint = f"api/books/{non_existent_id}"

    async with aiohttp.ClientSession() as session:
        async with session.get(f"{settings.HOST}/{endpoint}", headers=headers) as response:
            assert response.status == status.HTTP_400_BAD_REQUEST
            data = await response.json()
    assert data["detail"] == "Invalid book ID"


